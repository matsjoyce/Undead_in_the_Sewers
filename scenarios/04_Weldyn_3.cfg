#textdomain wesnoth-Undead_in_the_Sewers
[scenario]
    id=Weldyn_3
    name= _ "Weldyn"
    next_scenario=Sewer_Level_1
    map_data="{~add-ons/Undead_in_the_Sewers/maps/Weldyn_3.map}"
    turns=-1
    {DEFAULT_SCHEDULE}
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC "breaking_the_chains.ogg"}

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Discover the source of the undead"
                condition=win
            [/objective]
            [objective]
                description= _ "You die"
                condition=lose
            [/objective]
        [/objectives]
    [/event]

    [side]
        type=Stupid
        id=Stupid
        name= _ "Stupid"
        facing=se
        x,y=14,9
        side=1
        income=-2
        gold=0
        village_gold=0
        canrecruit=yes
        controller=human
        team_name=Player
        user_team_name=_ "Player"
    [/side]

    [side]
        no_leader=yes
        side=2
        team_name=Enemy
        user_team_name=_ "Enemy"
        income=0
        village_gold=0
        [ai]
            village_value=0
            agression=5
            caution=0
        [/ai]
        income=0
    [/side]

    [event]
        name=prestart

        {VARIABLE player_interlevel.hitpoints $player_interlevel.max_hitpoints}

        {VARIABLE player_interlevel.moves $player_interlevel.max_moves}

        [unstore_unit]
            variable=player_interlevel
            find_vacant=no
            #this is the start location of the leader of side 1, so the unstore will overwrite the old leader
            x,y=14,9
        [/unstore_unit]

        [unit]
            type=UitS_King
            id=Konrad
            name= _ "Konrad"
            side=1
            x,y=28,20
            facing=sw
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [unit]
            id=Delfador
            name= _ "Delfador"
            unrenamable=yes
            type=UitS Elder Mage
            facing=sw
            profile=portraits/delfador.png
            side=1
            x,y=30,19
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            id=Li'sar
            name= _ "Li'sar"
            unrenamable=yes
            type=UitS Elvish Lady
            facing=sw
            overlays="misc/orb-ally.png"
            profile=portraits/lisar.png
            [modifications]
                {TRAIT_LOYAL}
                movement_type=none
            [/modifications]
            side=1
            x,y=26,19
        [/unit]

        {PLACE_IMAGE "scenery/dummy.png" 47 21}

        {PLACE_IMAGE "scenery/dummy.png" 48 21}

        {PLACE_IMAGE "scenery/dummy.png" 49 21}

        {PLACE_IMAGE "scenery/tower.png" 44 8}

        {PLACE_IMAGE "items/archery-target-right.png" 31 6}

        {PLACE_IMAGE "items/archery-target-right.png" 33 6}

        {PLACE_IMAGE "items/archery-target-right.png" 35 6}

        {PLACE_IMAGE "scenery/sewer_grate.png" 12 31}

        {PLACE_IMAGE "scenery/tent-shop-weapons.png" 11 17}

        {PLACE_IMAGE "scenery/tent-shop-weapons.png" 11 19}

        {PLACE_IMAGE "scenery/temple1.png" 13 9}

        #This guy teaches bowmanship (is that a word? probably not :/)
        [unit]
            type=UitS Master Bowman
            id=Daethyn
            name= _ "Daethyn True-Aim"
            side=1
            x,y=32,5
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        {WALLGUARD 1 15 5} {GUARDIAN}

        {WALLGUARD 2 17 4} {GUARDIAN}

        {WALLGUARD 3 27 4} {GUARDIAN}

        {WALLGUARD 4 29 4} {GUARDIAN}

        {WALLGUARD 5 39 4} {GUARDIAN}

        {WALLGUARD 6 41 5} {GUARDIAN}

        {WALLGUARD 7 51 10} {GUARDIAN}

        {WALLGUARD 8 52 11} {GUARDIAN}

        {WALLGUARD 9 52 29} {GUARDIAN}

        {WALLGUARD 10 51 31} {GUARDIAN}

        {WALLGUARD 11 41 36} {GUARDIAN}

        {WALLGUARD 12 39 37} {GUARDIAN}

        {WALLGUARD 13 29 37} {GUARDIAN}

        {WALLGUARD 14 27 37} {GUARDIAN}

        {WALLGUARD 15 17 37} {GUARDIAN}

        {WALLGUARD 16 15 36} {GUARDIAN}

        {WALLGUARD 17 5 31} {GUARDIAN}

        {WALLGUARD 18 4 29} {GUARDIAN}

        {WALLGUARD 19 4 11} {GUARDIAN}

        {WALLGUARD 20 5 10} {GUARDIAN}

        #The general dude that sits on the tower near Konrad
        [unit]
            type=UitS General
            id=Rynon
            name= _ "General Rynon"
            facing=sw
            side=1
            x,y=26,21
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
                [object]
                    [effect]
                        apply_to=max_experience
                        increase=-7
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        #The ratcatcher
        [unit]
            type=UitS Peasant
            id=Keldyn
            name= _ "Keldyn the Ratcatcher"
            side=1
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        #blademaster
        [unit]
            type=UitS Royal Guard
            id=Borran
            x,y=48,19
            name= _ "Borran Blademaster"
            side=1
            overlays="misc/orb-ally.png"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [if]
            [variable]
                name=dialogue_done
                numerical_equals=1
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        id=Keldyn
                    [/filter]
                    kill=yes
                    variable=ratcatcher_store
                [/store_unit]

                [unstore_unit]
                    variable=ratcatcher_store
                    x,y=33,25
                [/unstore_unit]

                {CLEAR_VARIABLE ratcatcher_store}
            [/then]

            [else]
            [/else]
        [/if]

        [if]
            [variable]
                name=dialogue_done
                numerical_equals=1
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        id=$player.id
                    [/filter]
                    kill=yes
                    variable=stupid_store_2
                [/store_unit]

                {VARIABLE stupid_store.moves $stupid_store.max_moves}

                [unstore_unit]
                    variable=stupid_store
                    x,y=12,31
                [/unstore_unit]

                {CLEAR_VARIABLE stupid_store}
                {CLEAR_VARIABLE stupid_store_2}

                {SCROLL_TO 12 31}
            [/then]

            [else]
            [/else]
        [/if]

        #change TC for NPC's
        #don't need to change Delfador since he has no TC, but I'll do it just in #case his sprite ever gets TC. And Konrad's red bits (cloak and such) #aren't TC'ed, but his sprite will eventually get an update anyway, so I'll #include him as well
        {TEAM_COLOR_OVERRIDE id=Delfador blue}
        {TEAM_COLOR_OVERRIDE id=Li'sar blue}
        {TEAM_COLOR_OVERRIDE id=Konrad blue}
        {TEAM_COLOR_OVERRIDE id=Keldyn blue}
        {TEAM_COLOR_OVERRIDE id=Rynon blue}
        {TEAM_COLOR_OVERRIDE id=Daethyn blue}
        {TEAM_COLOR_OVERRIDE id=Borran blue}
        {TEAM_COLOR_OVERRIDE id=1 blue}
        {TEAM_COLOR_OVERRIDE id=2 blue}
        {TEAM_COLOR_OVERRIDE id=3 blue}
        {TEAM_COLOR_OVERRIDE id=4 blue}
        {TEAM_COLOR_OVERRIDE id=5 blue}
        {TEAM_COLOR_OVERRIDE id=6 blue}
        {TEAM_COLOR_OVERRIDE id=7 blue}
        {TEAM_COLOR_OVERRIDE id=8 blue}
        {TEAM_COLOR_OVERRIDE id=9 blue}
        {TEAM_COLOR_OVERRIDE id=10 blue}
        {TEAM_COLOR_OVERRIDE id=11 blue}
        {TEAM_COLOR_OVERRIDE id=12 blue}
        {TEAM_COLOR_OVERRIDE id=13 blue}
        {TEAM_COLOR_OVERRIDE id=14 blue}
        {TEAM_COLOR_OVERRIDE id=15 blue}
        {TEAM_COLOR_OVERRIDE id=16 blue}
        {TEAM_COLOR_OVERRIDE id=17 blue}
        {TEAM_COLOR_OVERRIDE id=18 blue}
        {TEAM_COLOR_OVERRIDE id=19 blue}
        {TEAM_COLOR_OVERRIDE id=20 blue}
    [/event]

    [event]
        name=turn 2
        [object]
            silent=yes
            [filter]
                id=Konrad
            [/filter]
            [effect]
                apply_to=image_mod
                replace=~RC(magenta>blue)
            [/effect]
        [/object]
    [/event]

    [event]
        name=start

        {VARIABLE player.moves $player.max_moves}
        {VARIABLE player_interlevel.moves $player_interlevel.max_moves}

        [unstore_unit]
            variable=player_interlevel
            find_vacant=no
            #this is the start location of the leader of side 1, so the unstore will overwrite the old leader
            x,y=14,9
        [/unstore_unit]

        [object]
            [filter]
                id=$player.id
            [/filter]

            silent=yes
            duration="scenario"

            [effect]
                apply_to="hitpoints"
                heal_full="yes"
            [/effect]
        [/object]

        {SET_LABEL 11 17 "Potion Shop"}
        {SET_LABEL 13 9 "Trophy Hall"}
        {SET_LABEL 11 19 "Smithy"}

        {MENU_ITEMS}

        {MAGIC_SHOP 44 8}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$player.id
            [filter_location]
                x,y=12,31
            [/filter_location]
        [/filter]

        [message]
            speaker=narrator
            message= _ "Do you want to go down to the sewers?"

            [option]
                message = _ "Yes."
                [command]
                    [store_unit]
                        [filter]
                            [filter_location]
                                x,y=12,31
                            [/filter_location]
                        [/filter]
                        variable=player_interlevel
                        kill=no
                    [/store_unit]

                    {VARIABLE level_two_waypoint down}

                    [endlevel]
                        result=victory
                        carryover_report=no
                        linger_mode=no
                        save=no
                        carryover_percentage=100
                    [/endlevel]
                [/command]
            [/option]

            [option]
                message = _ "No."
                [command]
                [/command]
            [/option]

            image=wesnoth-icon.png
        [/message]
    [/event]

    #to the trophy hall

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$player.id
            [filter_location]
                x,y=13,9
            [/filter_location]
        [/filter]

        [message]
            speaker=narrator
            message= _ "Do you want to enter the trophy hall?"

            [option]
                message = _ "Yes."
                [command]
                    [store_unit]
                        [filter]
                            [filter_location]
                                x,y=13,9
                            [/filter_location]
                        [/filter]
                        variable=player_interlevel
                        kill=no
                    [/store_unit]

                    [endlevel]
                        result=victory
                        next_scenario=Trophy_Hall
                        carryover_report=no
                        linger_mode=no
                        save=no
                        carryover_percentage=100
                    [/endlevel]
                [/command]
            [/option]

            [option]
                message = _ "No."
                [command]
                [/command]
            [/option]

            image=wesnoth-icon.png
        [/message]
    [/event]

    [event]
        first_time_only=no
        name=select

        [filter]
            id=Delfador
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        {RANDOM 0..13}

        [switch]
            variable=random

            [case]
                value=0
                [message]
                    speaker=Delfador
                    message= _ "Be careful when traveling through sewage! If you end your turn in light sewage, that hex will turn into deep sewage. End your turn in deep sewage, and you will sink and drown! This can be used as a method of defeating opponents; however, you receive no experience for the death of an enemy if it drowns in sewage."
                [/message]
            [/case]

            [case]
                value=1
                [message]
                    speaker=Delfador
                    message= _ "With that fine means of aquatic transportation you carry in your pack, you can switch between terrestrial and aquatic movetypes simply by moving to a dock and choosing the appropriate option."
                [/message]
            [/case]

            [case]
                value=2
                [message]
                    speaker=Delfador
                    message= _ "The next version of this campaign will focus primarily on loot, inventory, and selling things to merchants."
                [/message]
            [/case]

            [case]
                value=3
                [message]
                    speaker=Delfador
                    message= _ "Sometimes you will come across locked doors down in the sewer. Often you will need to find the correct key to unlock the door, but other times you will have to defeat a guardian, find a switch, or find another way around the door."
                [/message]
            [/case]

            [case]
                value=4
                [message]
                    speaker=Delfador
                    message= _ "If you are playing this campaign with the music turned off in the game preferences, try turning the music back on and heading down to the sewer. There are some cool atmospheric sounds instead of music in the sewer levels (but you need to have music enabled in the game preferences in order to hear the atmospheric sounds)."
                [/message]
            [/case]

            [case]
                value=5
                [message]
                    speaker=Delfador
                    message= _ "Please report any bugs you find in this campaign to artisticdude via the campaign's thread in the Scenario and Campaign Development forum on the Wesnoth forums."
                [/message]
            [/case]

            [case]
                value=6
                [message]
                    speaker=Delfador
                    message= _ "Yes, we are having nice weather today. But it's supposed to snow tomorrow, I hear!"
                [/message]
            [/case]

            [case]
                value=7
                [message]
                    speaker=Delfador
                    message= _ "If you run out of potions, you can always head back up to Weldyn and purchase some more from the potion shop to the west."
                [/message]
            [/case]

            [case]
                value=8
                [message]
                    speaker=Delfador
                    message= _ "The eagle has landed. Repeat: the eagle has- Oh, it flew away again. Darn it."
                [/message]
            [/case]

            [case]
                value=9
                [message]
                    speaker=Delfador
                    message= _ "What, you're aghast at the crappy art in this campaign? Be aware, however, that there are lots of placeholder assets in the campaign right now. Once the majority of the structure (that is to say, the code) of the campaign is finished, the developer will concentrate more on the assets (art, sound, etc.) of the campaign."
                [/message]
            [/case]

            [case]
                value=10
                [message]
                    speaker=Delfador
                    message= _ "My abs are hungry."
                [/message]
            [/case]

            [case]
                value=11
                [message]
                    speaker=Delfador
                    message= _ "Be sure to check your experience bar before gulping down precious health potions! Each time you gain a level, your character is restored to full health. So if your character is almost ready to level up, don't use a health potion unless you're at death's door."
                [/message]
            [/case]

            [case]
                value=12
                [message]
                    speaker=Delfador
                    message= _ "Please drive responsibly."
                [/message]
            [/case]

            [case]
                value=13
                [message]
                    speaker=Delfador
                    message= _ "Ding dong bell, undead in the well. Who put them there? Not a soul can tell..."
                [/message]
            [/case]
        [/switch]
    [/event]

    #Konrad's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Konrad
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Konrad
            message= _ "Have you found the source of the undead yet? No? Then what are you doing dawdling about up here, you stupid blockhead? There is no time to waste, we must stop the undead as soon as possible!"
        [/message]
    [/event]

    #Li'sar's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Li'sar
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Li'sar
            message= _ "I'm stuck with this elvish lady sprite until someone finds time to make me a better baseframe. And I need a new portrait, too..."
        [/message]
    [/event]

    #Rynon's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Rynon
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Rynon
            message= _ "I have no idea why I'm even here. Maybe I'm supposed to say something useful, but I have nothing useful to say. If you want advice, go talk to Delfador. He'll give you a random piece of advice (or nonsense) each time you talk to him. Say, I <i>did</i> just say something useful! Well well well!"
        [/message]
    [/event]

    #Keldyns dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Keldyn
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Keldyn
            message= _ "Oh, it was horrible! Horrible, I tell you! One can't even go about one's lawful business without being set upon by undead! Oh woe, woe!"
        [/message]
    [/event]

    #Borran's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Borran
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Borran
            message= _ "Eventually you will be able to come to me for instruction in melee combat, but not in this version of this campaign."
        [/message]
    [/event]

    #Daethyn's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Daethyn
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Daethyn
            message= _ "Eventually you will be able to come to me for instruction in ranged combat, but not in this version of this campaign."
        [/message]
    [/event]

    {BRAKKON_FORGEMASTER 11 19}

    {JABBON_POTIONMASTER 11 17}

    {SET_UNLIMITED_MOVEMENT}
[/scenario]
