#textdomain wesnoth-Undead_in_the_Sewers
[scenario]
    id=Sewer_Level_2_2
    name=_ "Sewer Level 2"
    next_scenario=null
    map_data="{~add-ons/Undead_in_the_Sewers/maps/Level_2_2.map}"
    turns=-1
    {UNDERGROUND}
    [+time]
        red,green,blue=-55,-55,-55
    [/time]
    victory_when_enemies_defeated=no
    {SCENARIO_MUSIC "ambient/sewer_1.ogg"}
    [event]
        name=preload
        first_time_only=no
        [lua]
            code=<<
			helper =wesnoth.require("lua/helper.lua")
wesnoth.dofile("~add-ons/Undead_in_the_Sewers/lua/wml_tags.lua")
>>
        [/lua]
    [/event]
    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description=_ "Enter the next level"
                condition=win
            [/objective]
            [objective]
                description=_ "You die"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]
    [side]
        type=Stupid
        id=Stupid
        name=_ "Stupid"
        side=1
        income=-2
        village_gold=0
        gold=0
        shroud=yes
        fog=yes
        canrecruit=yes
        controller=human
        team_name=Player
        user_team_name=_ "Player"
    [/side]
    [side]
        no_leader=yes
        side=2
        income=0
        village_gold=0
        team_name=Undead
        user_team_name=_ "Undead"
        [ai]
            agression=1
            caution=0
            village_value=0
            grouping=offensive
            [target]
                id=$player.id
                value=9
            [/target]
            [goal]
                [criteria]
                    side=1
                    id=$player.id
                [/criteria]
                value=1
            [/goal]
            #despite these AI directives, enemy units won't always attack you if they #have only a few hitpoints left. I don't know why, but there's nothing I #can do about it.
            {AI_SIMPLE_ALWAYS_ASPECT combat_ignore_bad_movements yes}
            {AI_SIMPLE_ALWAYS_ASPECT combat_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.9}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.0}
        [/ai]
    [/side]
    [side]
        no_leader=yes
        side=3
        income=0
        village_gold=0
        team_name=Player
        user_team_name=_ "Player"
        [ai]
            agression=1
            caution=0
            village_value=0
            grouping=offensive
            [target]
                side=2
                value=9
            [/target]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=1
            [/goal]
            {AI_SIMPLE_ALWAYS_ASPECT combat_ignore_bad_movements yes}
            {AI_SIMPLE_ALWAYS_ASPECT combat_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.9}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.0}
        [/ai]
    [/side]
    {ANIMATED_BRAZIER 11 32}
    {ANIMATED_BRAZIER 10 35}
    {ANIMATED_BRAZIER 12 40}
    {ANIMATED_BRAZIER 8 45}
    {ANIMATED_BRAZIER 11 6}
    {ANIMATED_BRAZIER 3 11}
    {ANIMATED_BRAZIER 2 2}
    {ANIMATED_BRAZIER 15 23}
    {ANIMATED_BRAZIER 41 3}
    {ANIMATED_BRAZIER 38 13}
    {LOCOMOTION_TRANSITION 14,5 24,14}
    {DANGEROUS_SEWAGE}

    [event]
        name=prestart

        [unstore_unit]
            variable=player_interlevel
            find_vacant=no
            #this is the start location of the leader of side 1, so the unstore will overwrite the old leader
            x,y=42,13
        [/unstore_unit]

        [kill]
            id=Stupid
        [/kill]

        [if]
            [variable]
                name=visited_second
                numerical_equals=1
            [/variable]
            [then]
                [set_shroud]
                    side=1
                    shroud_data=$shroud_data
                [/set_shroud]
            [/then]
            [else]
            [/else]
        [/if]

        #the portal
        {PLACE_IMAGE "scenery/monolith2.png" 36 1}

        [if]
            [variable]
                name=talked_to_Morran
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                {PLACE_IMAGE "scenery/gate-rusty-sw.png" 14 2}
                [terrain]
                    x,y=14,2
                    terrain=Urb^Xo
                [/terrain]
            [/else]
        [/if]
        {PLACE_IMAGE "scenery/stairs-spiral.png" 15 36}
        {PLACE_IMAGE "items/chest-plain-closed.png" 15 32}
        {PLACE_IMAGE "scenery/brokenbarrel.png" 10 26}
        [if]
            [variable]
                name=used_exit
                equals=yes
            [/variable]
            [then]
                {PLACE_IMAGE "scenery/trapdoor-open.png" 42 13}
            [/then]
            [else]
                {PLACE_IMAGE "scenery/trapdoor-closed.png" 42 13}
            [/else]
        [/if]
        {PLACE_IMAGE data/campaigns/Under_the_Burning_Suns/images/terrain/summoning-circle5.png 2 44}
        #These three are the runes that unlock the door to the south-east
        {PLACE_IMAGE terrain/summoning-center-green.png 38 28}
        {PLACE_IMAGE terrain/summoning-center-red.png 40 29}
        {PLACE_IMAGE terrain/summoning-center-blue.png 42 30}
        {PLACE_IMAGE scenery/signpost.png 2 42}
        {PLACE_IMAGE scenery/signpost.png 32 31}
        [set_variable]
            name=healing_rune_charge
            value=16
        [/set_variable]

        #determining which way the switch should point
        [if]
            [variable]
                name=switch_orientation
                equals=left
            [/variable]
            [then]
                [remove_item]
                    x,y=5,3
                [/remove_item]

                {PLACE_IMAGE "scenery/switch-left.png" 5 3}
            [/then]
            [else]
                [remove_item]
                    x,y=5,3
                [/remove_item]

                {PLACE_IMAGE "scenery/switch-right.png" 5 3}
            [/else]
        [/if]

        #the gate to the counterweight switch room
        [if]
            [variable]
                name=switch_gate_open
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                {PLACE_IMAGE "scenery/gate-rusty-sw.png" 5 5}
                [terrain]
                    x,y=5,5
                    terrain=Ur^Xo
                [/terrain]
            [/else]
        [/if]

        #the gate in front of Morran's place
        [if]
            [variable]
                name=found_wesnothians
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                {PLACE_IMAGE "scenery/gate-rusty-sw.png" 5 11}
                [terrain]
                    x,y=5,11
                    terrain=Ur^Xo
                [/terrain]
            [/else]
        [/if]

        #note that the id's of the units below, while they are technically single  #values, are pseudo-variable strings, with the values preceding the unit  #type indicating what level the unit belongs to (without this there would  #be duplicate id's between levels, which would then trigger spawn  #deficiencies between levels), the middle value indicates the type of  #creature the unit is, and the concluding value sets the assigned numerical  #id of the unit (since there is often more than one of any given kind of  #unit in a level).
        #the first zombie you meet in the passageway
        {NPC_SPAWN_CHECK "Walking Corpse"  2zombie1 9 33 ""}
        #The ghoul in the passageway
        {NPC_SPAWN_CHECK Ghoul 2ghoul1 9 39 ""}
        #the first zombie you meet in the nw room
        {NPC_SPAWN_CHECK "Walking Corpse"  2zombie2 6 28 ""}
        #the ghost guarding the treasure
        {NPC_SPAWN_CHECK "Ghost"  2ghost1 15 33 ""}
        #the zombie east of the healing run
        {NPC_SPAWN_CHECK "Walking Corpse"  2zombie3 22 41 ""}
        #the rat
        {NPC_SPAWN_CHECK "Giant Rat" 2giantrat1 16 40 ""}
        #the ghoul in the northern area
        {NPC_SPAWN_CHECK Ghoul 2ghoul2 22 23 ""}
        #the rat guarding the movement potion
        {NPC_SPAWN_CHECK "Giant Rat" 2giantrat2 25 30 ""}
        #the zombie guarding the bridge
        {NPC_SPAWN_CHECK "Walking Corpse"  2zombie4 3 19 ""}
        #the bat
        {NPC_SPAWN_CHECK "Vampire Bat" 2vampirebat1 16 26 ""}
        #the more powerful bat by the dock
        {NPC_SPAWN_CHECK "Blood Bat" 2bloodbat1 14 22 ""}

        [if]
            [variable]
                name=talked_to_Morran
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                #Northern undead defense force
                {NPC_SPAWN_CHECK "Ghost" 2ghost2 22 2 ""}
                {NPC_SPAWN_CHECK "Skeleton Archer" 2skeletonarcher1 31 7 ""}
                {NPC_SPAWN_CHECK "Soulless" 2soulless1 19 3 ""}
                {NPC_SPAWN_CHECK "Walking Corpse" 2zombie3 19 4 ""}
                {NPC_SPAWN_CHECK "Skeleton" 2skeleton1 25 6 ""}
                {NPC_SPAWN_CHECK "Walking Corpse" 2zombie4 23 10 ""}
                {NPC_SPAWN_CHECK "Ghost" 2ghost3 28 8 ""}
                {NPC_SPAWN_CHECK "Soulless" 2soulless2 33 5 ""}

                #the beleaguered repair crew
                {LOYAL_UNIT 3 "Heavy Infantryman" 14 3}
                {LOYAL_UNIT 3 "Bowman" 9 2}
                {LOYAL_UNIT 3 "Bowman" 10 5}
                {LOYAL_UNIT 3 "Javelineer" 10 6}
                {LOYAL_UNIT 3 "Spearman" 11 7}
                {LOYAL_UNIT 3 "Swordsman" 4 7}
            [/else]
        [/if]
    [/event]
    #aaaaand here we have... the potions...
    {CP 2CP1 7 38}
    {CP 2CP2 41 23}
    {HP 2HP1 44 16}
    {HP 2HP2 23 23}
    {MP 2MP1 25 31}

    [event]
        name=start

        {CLEAR_VARIABLE player_interlevel}

        {MENU_ITEMS}

        [sound_source]
            id=sign
            sounds=ambient/fire.ogg
            x=11,10,12,8 ,11,3 ,2,15,41,38
            y=32,35,40,45,6 ,11,2,23,3 ,13
            fade_range=4
            full_range=4
            loop=-1
            check_fogged=true
        [/sound_source]

        {SCROLL_TO 42 13}

        [if]
            [variable]
                name=initial_dialogue_done
                not_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message=_ "You enter the second level of the Weldyn sewers. Other than being considerably wetter than the first level (as though that were even possible), the two levels seem to be pretty similar. Lots of stone, brick, muck, and filthy water. And, of course, hordes of bloodthirsty undead.
There is one thing that's different about this level, however. Above the usual sounds of massive undead-infested sewers (drips, plops, growls, roars, screeches, clattering, groans, scratching, etc.), you can distinctly make out a low-pitched humming noise. It seems to be originating from the south-west."
                [/message]
                [set_variable]
                    name=initial_dialogue_done
                    value=yes
                [/set_variable]
            [/then]
            [else]
            [/else]
        [/if]
    [/event]
    [event]
        name=moveto
        [filter]
            id=$player.id
            [filter_location]
                x,y=42,13
            [/filter_location]
        [/filter]
        [if]
            [variable]
                name=used_exit
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                [sound]
                    name=open-chest.wav
                [/sound]
                [set_variable]
                    name=used_exit
                    value=yes
                [/set_variable]
            [/else]
        [/if]
    [/event]
    #Healing rune
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=2,44
            id=$player.id
        [/filter]
        [if]
            [variable]
                name=healing_rune_charge
                greater_than_equal_to=16
            [/variable]
            [then]
                #this bit stolen from UtBS
                [sound]
                    name=lightning.ogg
                [/sound]
                [color_adjust]
                    red,green,blue=31,122,255
                [/color_adjust]
                [redraw]
                [/redraw]
                [delay]
                    time=100
                [/delay]
                [color_adjust]
                    red,green,blue=0,0,0
                [/color_adjust]
                [redraw]
                [/redraw]
                [heal_unit]
                    [filter]
                        id=$player.id
                    [/filter]
                    amount=60
                [/heal_unit]
                [set_variable]
                    name=healing_rune_charge
                    value=0
                [/set_variable]
                {REMOVE_IMAGE 2 44}
                {PLACE_IMAGE "terrain/summoning-circle5-dead.png" 2 44}
                [message]
                    speaker=narrator
                    image=data/campaigns/Under_the_Burning_Suns/images/terrain/summoning-circle5.png
                    message=_ "The humming noise abruptly ends when you step on the rune. A wave of energy courses through your body, refreshing and rejuvenating you."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=$player.id
                    message=_ "Hmm, nothing's happening. I guess the rune needs to charge more before I can use it again..."
                [/message]
            [/else]
        [/if]
    [/event]
    #Healing rune recharge function. Rather than having the recharge turn  counter only go up to 16 (which would then cause the 'recharge complete'  dialogue to fire each turn after the recharge is complete until the turn  the player stepped on it again), I simply had the recharge turn count  continue to infinity after it reaches 16 and set the recharge dialogue  only to fire only on the turn when the recharge turn count equals 16.  Because of this, I set the rune to work if the recharge turn count is 16  or higher. Note that the charge status is also signified by the image used  to portray the rune; it is bright blue when fully charged, and dull and  dark when it is charging.
    [event]
        name=new_turn
        first_time_only=no
        [set_variable]
            name=healing_rune_charge
            add=1
        [/set_variable]
        [if]
            [variable]
                name=healing_rune_charge
                equals=16
            [/variable]
            [then]
                {REMOVE_IMAGE 2 44}
                {PLACE_IMAGE data/campaigns/Under_the_Burning_Suns/images/terrain/summoning-circle5.png 2 44}
                [message]
                    speaker=narrator
                    image=data/campaigns/Under_the_Burning_Suns/images/terrain/summoning-circle5.png
                    message=_ "You hear the humming noise start up again. The healing rune must be fully recharged."
                [/message]
            [/then]
            [else]
            [/else]
        [/if]
    [/event]
    #the signpost by the healing rune
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=2,42
            id=$player.id
        [/filter]
        [message]
            speaker=narrator
            image=scenery/signpost.png
            message=_ "'Healing rune. For use of sewer maintenance crews only. The rune requires a recharge time of 16 minutes after each use.'
'Results of stepping on the rune before it has fully recharged include but are not limited to spontaneous combustion, inexplicable subconscious urges to wear bell-bottomed pants and spangles, instantaneous molecular disintegration, severe headaches, vomiting, diarrhea, dizziness, and a sudden addiction to strawberry poptarts and/or tennis balls.'"
        [/message]
    [/event]
    #Going back up to Sewer Level 1
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=$player.id
            [filter_location]
                x,y=15,36
            [/filter_location]
        [/filter]
        [message]
            speaker=narrator
            message=_ "Do you want to go back up to the first level of the sewer?"
            [option]
                message =_ "Yes."
                [command]
                    #here I store the shroud data for the shroud-storing lua function
                    [store_shroud]
                        side=1
                        variable=shroud_data
                    [/store_shroud]
                    [set_variable]
                        name=level_two_waypoint
                        value=up
                    [/set_variable]

                    [store_unit]
                        [filter]
                            [filter_location]
                                x,y=15,36
                            [/filter_location]
                        [/filter]
                        variable=player_interlevel
                        kill=yes
                    [/store_unit]

                    [if]
                        [variable]
                            name=visited_second
                            numerical_equals=1
                        [/variable]
                        [then]
                        [/then]
                        [else]
                            [set_variable]								name=visited_second
                                add=1
                            [/set_variable]
                        [/else]
                    [/if]
                    [endlevel]
                        result=victory
                        next_scenario=Sewer_Level_1_2
                        carryover_report=no
                        linger_mode=no
                        carryover_percentage=100
                    [/endlevel]
                [/command]
            [/option]
            [option]
                message =_ "No."
                [command]
                [/command]
            [/option]
            image=wesnoth-icon.png
        [/message]
    [/event]
    #Exiting the level
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=$player.id
            [filter_location]
                x,y=42,13
            [/filter_location]
        [/filter]
        [if]
            [variable]
                name=used_exit
                equals=yes
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message=_ "Do you want to go deeper into the sewers?"
                    [option]
                        message =_ "Yes."
                        [command]
                            [store_shroud]
                                side=1
                                variable=shroud_data
                            [/store_shroud]
                            [set_variable]
                                name=level_two_waypoint
                                value=down
                            [/set_variable]

                            [store_unit]
                                [filter]
                                    [filter_location]
                                        x,y=42,13
                                    [/filter_location]
                                [/filter]
                                variable=player_interlevel
                                kill=yes
                            [/store_unit]

                            [if]
                                [variable]
                                    name=visited_second
                                    numerical_equals=1
                                [/variable]
                                [then]
                                [/then]
                                [else]
                                    [set_variable]								name=visited_second
                                        add=1
                                    [/set_variable]
                                [/else]
                            [/if]

                            [endlevel]
                                result=victory
                                next_scenario=Sewer_Level_3
                                carryover_report=no
                                linger_mode=no
                                save=no
                            [/endlevel]
                        [/command]
                    [/option]
                    [option]
                        message =_ "No."
                        [command]
                        [/command]
                    [/option]
                    image=wesnoth-icon.png
                [/message]
            [/then]
            [else]
                [remove_item]
                    x,y=42,13
                [/remove_item]
                {PLACE_IMAGE "scenery/trapdoor-open.png" 42 13}
                [sound]
                    name=open-chest.wav
                [/sound]
                [set_variable]
                    name=used_exit
                    value=yes
                [/set_variable]
                [message]
                    speaker=narrator
                    message=_ "Do you want to go deeper into the sewers?"
                    [option]
                        message =_ "Yes."
                        [command]
                            [message]
                                speaker=narrator
                                caption=artisticdude
                                message=_"You have reached the end of the demo area. Much more coming in the next version of this campaign, primarily in the form of shops and NPC interaction.
								Give me your thoughts and suggestions about this campaign! Post a message in the campaign's thread in the Scenario and Campaign Development forum on the Wesnoth forum board, I'd appreciate it greatly. =)"
                            [/message]
                            [endlevel]
                                result=victory
                                next_scenario=null
                                carryover_report=no
                                linger_mode=no
                                save=no
                            [/endlevel]
                        [/command]
                    [/option]
                    [option]
                        message =_ "No."
                        [command]
                        [/command]
                    [/option]
                    image=wesnoth-icon.png
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=moveto
        [filter]
            id=$player.id
            [filter_location]
                x,y=4,11
            [/filter_location]
        [/filter]
        [if]
            [variable]
                name=found_wesnothians
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                [message]
                    speaker=narrator
                    message=_ "You step in front of yet another iron gate, wondering why on earth anyone would put so many gates in a sewer. As you begin to search for a keyhole or some way to open the gate, you are quite startled when it begins to open. Stepping back to avoid being hit by the swinging bulk of iron and drawing your sword -just in case- you are further surprised to see a soldier of Wesnoth coming towards you through the passage beyond the gate."
                [/message]

                [sound]
                    name=gate.ogg
                [/sound]

                [remove_item]
                    x,y=5,11
                [/remove_item]
                [terrain]
                    x,y=5,11
                    terrain=Ur
                [/terrain]

                {MOVE_UNIT x,y=10,6 5 11}
                [set_variable]
                    name=found_wesnothians
                    value=yes
                [/set_variable]

                [store_unit]
                    variable=speaker_store
                    kill=no
                    [filter]
                        x,y=5,11
                    [/filter]
                [/store_unit]

                [message]
                    speaker=$speaker_store.id
                    message= _ "Are you a zombie?"
                [/message]

                [message]
                    speaker=$player.id
                    message= _ "No."
                [/message]

                [message]
                    speaker=$speaker_store.id
                    message= _ "Oh. Well, you can come in then, I guess. Follow me."
                [/message]

                [message]
                    speaker=$player.id
                    message= _ "Umm... okay."
                [/message]

                {MOVE_UNIT x,y=5,11 10 6}

                [unit]
                    type=White Mage
                    id=Morran
                    side=1
                    name=_ "Morran"
                    x,y=12,5
                    facing=nw
                    overlays="misc/orb-ally.png"
                    [modifications]
                        {TRAIT_LOYAL}
                        movement_type=none
                    [/modifications]
                [/unit]

                {TEAM_COLOR_OVERRIDE id=Morran green}

                {MOVE_UNIT x,y=4,11 9 7}

                [message]
                    speaker=Morran
                    message= _ "Greetings, stranger. Approach and speak with me (remember, to speak with an NPC, just move to a space adjacent to the NPC and select him or her)."
                [/message]
            [/else]
        [/if]
    [/event]

    #Morran's dialogue
    [event]
        first_time_only=no
        name=select

        [filter]
            id=Morran
            [filter_adjacent]
                id=$player.id
            [/filter_adjacent]
        [/filter]

        [message]
            speaker=Morran
            message= _ "It is rare indeed that we see anyone down here besides undead... what is your purpose in coming here?"
        [/message]

        [message]
            speaker=$player.id
            message= _ "I'm on an epic quest, to locate and destroy the source of undead in these sewers. Why are you down here?"
        [/message]

        [message]
            speaker=Morran
            message= _ "Hah! The undead have been a recurring problem since these sewers were first built. We were sent down here by Asheviere about five years ago to do a routine maintenance check, only to be trapped down here by a simultaneous earthquake and flood. We had nothing to build a boat from, and none of us ever learned to swim, so we've been stuck down here ever since, with the undead on one side and the water on the other."
        [/message]

        [message]
            speaker=$player.id
            message= _ "I am given to understand that there is a portal down here somewhere... but I have yet to find it. Perhaps it is past that gate to the north?"
        [/message]

        [message]
            speaker=Morran
            message= _ "It is, and we have actually managed to fight our way through the hordes of undead on the other side of that gate and reach the portal, but it's broken. No power crystal. And without a power crystal, it's useless. I, umm... don't suppose you've got any power crystals, by any chance?"
        [/message]

        [message]
            speaker=$player.id
            message= _ "Why, yes, actually... I do. I do have some power crystals."
        [/message]

        [message]
            speaker=Morran
            message= _ "What?! This is... this is wonderful! What do you say, shall we fight our way to the portal and escape this dreadful place?"
        [/message]

        [message]
            speaker=$player.id
            message= _ "You can, but I still have a quest to complete. However, since the way further down into the sewer probably lies beyond that gate, I'll help you reach the portal and power it up for you."
        [/message]

        [message]
            speaker=Morran
            message= _ "Excellent! Here's the plan. We'll take the undead while you sneak around and activate the portal. It should be somewhere against the north wall; just put the crystal in the holder and we'll take it from there."
        [/message]

        [message]
            speaker=$player.id
            message= _ "Sounds good to me."
        [/message]

        [message]
            speaker=Morran
            message= _ "Come, men! I know you're as sick of eating mushrooms and fungus as I am; let's fight for our freedom! Open the gate and chaaaarge!"
        [/message]

        [store_unit]
            [filter]
                id=Morran
            [/filter]
            kill=yes
            variable=Morran_store
        [/store_unit]

        {CLEAR_VARIABLE Morran_store}

        [unit]
            type=White Mage
            id=Morran
            side=3
            name=_ "Morran"
            x,y=12,5
            facing=nw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [message]
            speaker=narrator
            message= _ "Unfortunately, as the northern gate opens, the southern gate you entered through closes. It must be a sort of counterweight system. Still, if you ever needed to get back through the southern gate, there should be a lever around here somewhere to operate the gates. But you can look into that later. Right now, you've got a job to do."
        [/message]

        [sound]
            name=gate.ogg
        [/sound]

        {PLACE_IMAGE "scenery/gate-rusty-sw.png" 5 11}
        [terrain]
            x,y=5,11
            terrain=Ur^Xo
        [/terrain]

        [set_variable]
            name=talked_to_Morran
            value=yes
        [/set_variable]

        [remove_item]
            x,y=14,2
        [/remove_item]

        [terrain]
            x,y=14,2
            terrain=Urb
        [/terrain]
    [/event]

    #the counterweight system lever
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$player.id
            [filter_location]
                x,y=5,3
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=switch_orientation
                equals=left
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    caption=Inventory
                    message="Do you want to push the lever to the right?"

                    [option]
                        message= _ "Yes."
                        [command]
                            [sound]
                                name=024-Door01.ogg
                            [/sound]

                            [remove_item]
                                x,y=5,3
                            [/remove_item]

                            {PLACE_IMAGE "scenery/switch-right.png" 5 3}

                            [remove_item]
                                x,y=14,2
                            [/remove_item]

                            [terrain]
                                x,y=14,2
                                terrain=Urb
                            [/terrain]

                            [sound]
                                name=gate.ogg
                            [/sound]

                            {PLACE_IMAGE "scenery/gate-rusty-sw.png" 5 11}
                            [terrain]
                                x,y=5,11
                                terrain=Ur^Xo
                            [/terrain]

                            [set_variable]
                                name=switch_orientation
                                value=right
                            [/set_variable]
                        [/command]
                    [/option]

                    [option]
                        message= _ "No."
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/then]

            [else]
                [message]
                    speaker=narrator
                    caption=Inventory
                    message="Do you want to push the lever to the left?"

                    [option]
                        message= _ "Yes."
                        [command]
                            [sound]
                                name=024-Door01.ogg
                            [/sound]

                            [remove_item]
                                x,y=5,3
                            [/remove_item]

                            {PLACE_IMAGE "scenery/switch-left.png" 5 3}

                            [remove_item]
                                x,y=5,11
                            [/remove_item]
                            [terrain]
                                x,y=5,11
                                terrain=Ur
                            [/terrain]

                            [sound]
                                name=gate.ogg
                            [/sound]

                            {PLACE_IMAGE "scenery/gate-rusty-sw.png" 14 2}
                            [terrain]
                                x,y=14,2
                                terrain=Urb^Xo
                            [/terrain]

                            [set_variable]
                                name=switch_orientation
                                value=left
                            [/set_variable]
                        [/command]
                    [/option]

                    [option]
                        message= _ "No."
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/else]
        [/if]
    [/event]

    #event for moving to the portal
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$player.id
            [filter_location]
                x,y=36,1
            [/filter_location]
        [/filter]

        [kill]
            side=3
        [/kill]

        [if]
            [variable]
                name=got_they_key
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                [message]
                    speaker=narrator
                    message= _ "This obelisk must be the portal you are looking for. Noticing a small groove in the side of the obelisk, you take one of the crystals from the bag King Konrad gave you and place it into the groove. Instantly the portal flares to life, crackling and glowing with energy."
                [/message]

                [message]
                    speaker=narrator
                    message= _ "The Wesnothians fighting the undead all around you can sense the sudden increase of energy, and they suddenly break off combat and race towards the portal, dodging the undead as they attempt to reach the one chance of freedom from these filthy sewers that they have called home for the last five years. One by one, they reach the portal, touch the surface, then disappear. Whether they are being safely returned to Weldyn or instantly obliterated by the energy pulsing through the portal, you have no idea."
                [/message]

                [if]
                    [have_unit]
                        side=3
                        [filter]
                            id=Morran
                        [/filter]
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message= _ "The last person to reach the portal is Morran. Just before he touches the obelisk, he reaches into his pocket and hands you a small iron key. 'To the room that controls the counterweight gates. It's to the north-west, back in the place where you found us,' he says, by way of explanation. Then he touches the portal and vanishes.


Once again, it's just you and the undead."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=narrator
                            message= _ "The last Wesnothian reaches the portal. Morran has not yet shown up; he must have perished battling the undead. As the last soldier prepares to touch the portal, he hands you a small iron key. 'To the room that controls the counterweight gates. It's to the north-west, back in the place where you found us,' he says, by way of explanation. Then he touches the portal and vanishes.


Once again, it's just you and the undead."
                        [/message]
                    [/else]
                [/if]

                [set_variable]
                    name=got_the_key
                    value=yes
                [/set_variable]
            [/else]
        [/if]
    [/event]

    #moveto event for the gate that allows you to enter the counterweight #switch room
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=$player.id
            [filter_location]
                x,y=4,5
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=got_the_key
                equals=yes
            [/variable]
            [then]
                [sound]
                    name=gate.ogg
                [/sound]

                [remove_item]
                    x,y=5,5
                [/remove_item]

                [terrain]
                    x,y=5,5
                    terrain=Ur
                [/terrain]

                [message]
                    speaker=narrator
                    message = _ "One of your keys unlocks the gate."
                [/message]

                [set_variable]
                    name=switch_gate_open
                    value=yes
                [/set_variable]
            [/then]
            [else]
            [/else]
        [/if]
    [/event]
[/scenario]
